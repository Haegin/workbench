#!/bin/sh

# Use scdl to download tracks from soundcloud playlists to `download_folder`
# after downloading, if #Â of files in `download_folder/playlist` increased an
# apple script is invoked to re-create a playlist in iTunes.
#
# This is not a sync, but is enough for what I want right now :)
# NOTE: non mp3 tracks or tracks that are not downloadable will be skipped
#
# Required: OSX, python3, curl, scdl (https://github.com/flyingrub/scdl)
#   brew install python3 curl
#   pip3 install scdl

# set encoding
LANG="en_GB.UTF-8"

# prep folders for downloads
download_folder="/Users/$USER/Downloads/SoundCloud"
apple_script="/u/code/workbench/apple_scripts/add_folder_tracks_to_playlist.scpt"
mkdir -p $download_folder
mkdir -p Likes
cd $download_folder

function download_and_import_tracks () {
  # ensure target folder exists
  mkdir -p "$download_folder/$5"

  # count tracks in folder
  num_tracks=`ls -1 "$download_folder/$5" | wc -l`
  # download playlist tracks to folder
  /usr/local/bin/scdl -l $1 $2 --hidewarnings --hide-progress --onlymp3 $6
  # count tracks in folder again
  new_tracks=$(( `ls -1 "$download_folder/$5" | wc -l` - num_tracks))

  # check if we have any new files
  if [ "$new_tracks" -gt 0 ]; then
    # import new files to iTunes
    echo "Importing" $new_tracks "new tracks to iTunes playlist" $3
    osascript $apple_script "$3" "$4" > /dev/null
  else
    echo "No new tracks for playlist" $3
  fi
}

download_and_import_tracks "https://soundcloud.com/matt_hutchinson/sets/poolside-fm" "-c" "Poolside.FM" "Users:$USER:Downloads:SoundCloud:Poolside.FM (best of):" "Poolside.FM (best of)/"
download_and_import_tracks "https://soundcloud.com/matt_hutchinson/sets/fffffounnd-tracks" "-c" "FFFFFOUNND Tracks" "Users:$USER:Downloads:SoundCloud:FFFFFOUNND Tracks:" "FFFFFOUNND Tracks"
download_and_import_tracks "https://soundcloud.com/matt_hutchinson" "-fc" "SoundCloud Likes" "Users:$USER:Downloads:SoundCloud:Likes" "Likes" "--path ./Likes"

echo "Done! -" `date`
