#!/bin/bash
# Matthew Hutchinson - mh@housetrip.com
# this prints out some branch status from remote/origin relative
# to whatever tracking branch you specify in ARG
# and shows behind information (if it is behind)
# (modified from branch-status command http://github.com/jehiah

# example:
# $ branches-behind origin/master
# or add some regex for branches to ignore e.g.
# $ branches-behind origin/master 'staging|val|interhome|google|consumer|fix|inbox|ck_|production'
# or show the top 5 most behind
# $ branches-behind origin/master | sort -gr | head -n5

args=("$@")


if [ -z ${args[0]} ] ; then
  echo "usage: `basename $0` git_directory tracking_branch [optional regex of branches to ignore]"
  exit 65
fi

cd ${args[0]}

git for-each-ref --format="%(refname:short) %(upstream:short)" refs/remotes/origin | \
  while read branch
  do
    tracking=${args[1]}

    # must pass in a tracking branch
    [ -z "$tracking" ] && continue

    # remote branches to ignore (regex)
    if [ $args[2] ] ; then
      [[ "$branch" =~ ${args[2]} ]] && continue
    fi

    git rev-list --left-right ${branch}...${tracking} -- 2>/dev/null >/tmp/git_upstream_status_delta || continue
    LEFT_AHEAD=$(grep -c '^<' /tmp/git_upstream_status_delta)
    RIGHT_AHEAD=$(grep -c '^>' /tmp/git_upstream_status_delta)
    if [ $RIGHT_AHEAD -gt 0 ] ; then
      echo "$RIGHT_AHEAD $branch is behind $tracking"
    fi
  done
