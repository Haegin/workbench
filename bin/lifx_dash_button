#!/usr/bin/env ruby

require 'packetfu'
require 'lifx'

MIN_LIFX_LIGHT_COUNT = 4
LIFX_DASH_BUTTON_MAC = '90:72:40:0b:f2:f4'

# init client
begin
  puts "looking for lights ..."
  client = LIFX::Client.lan
  # # wait to find at least 3 lights
  client.discover! { |c| c.lights.count >= MIN_LIFX_LIGHT_COUNT }
  puts "found lights"
rescue LIFX::Client::DiscoveryTimeout
  puts "sorry, I couldn't find any lights"
  exit 1
end

def toggle_all_lifx_lights(client)
  # toggle all lights on or off
  if client.lights.first.on?
    client.lights.turn_off
    puts "#{Time.now} - turning lights OFF"
  else
    client.lights.turn_on
    puts "#{Time.now} - turning lights ON"
  end

  # ensure all packets are flushed
  client.flush
end


# sniff and filter for ARP probe packets
cap = PacketFu::Capture.new(:iface => (ARGV[0] || 'en1'), :start => true, :filter => 'arp')

pkt_count = 0
cap.stream.each do |pkt|
  # parse packet and examime src mac address
  arpreq  = PacketFu::ARPPacket.parse(pkt)
  src_mac = PacketFu::EthHeader.str2mac(arpreq.eth_src)
  src_ip  = arpreq.arp_src_ip_readable
  if src_mac == LIFX_DASH_BUTTON_MAC
    if arpreq.arp_opcode == 1
      # since we usually get 2 ARP packets, only operate on one of them
      if pkt_count % 2 == 0
        toggle_all_lifx_lights(client)
        # puts "pktcount -> #{pkt_count.to_s} -- #{arpreq.peek_format}"
      end
      pkt_count += 1
    end
  end
end

