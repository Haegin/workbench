#!/usr/bin/env ruby
# encoding: UTF-8

# Travis Status Check (requires travis gem and pro account)

# gem install travis
# travis login --pro
# travis token --pro
# (paste token below)

require "travis/pro"
require "awesome_print"

unless ENV['TMUX_TRAVIS_TOKEN'] && ENV['TMUX_TRAVIS_REPO']
  puts "Failed: TMUX_TRAVIS_TOKEN and TMUX_TRAVIS_REPO env vars required"
  exit 1
end

# helper methods
def valid_build?(build)
  build.finished? &&
    build.branch_info =~ /master/ &&
    !build.errored? &&
    !build.pull_request?
end

def show_state(build)
  puts "#{build.finished_at} - #{build.state}"
end

# connect to travis with env credentials
Travis::Pro.access_token = ENV['TMUX_TRAVIS_TOKEN']
repo = Travis::Pro::Repository.find(ENV['TMUX_TRAVIS_REPO'])

# show initial build status if present
if build = repo.builds.detect { |build| valid_build?(build) }
  show_state(build)
end

# listen for finished builds on the stream
Travis::Pro.listen(repo) do |stream|
  # stream.on('build:started', 'build:finished') do |event|
  stream.on('build:finished') do |event|
    ap event
    if valid_build?(event.build)
      show_state(event.build)
    end
  end
end
