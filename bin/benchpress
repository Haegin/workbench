#!/usr/bin/env ruby

puts 'Installing the workbench'

path = File.expand_path('./', File.dirname(__FILE__))
bin_path = File.symlink?(path) ? File.readlink(path) : path
workbench_path = File.expand_path('.././', bin_path)

Dir.chdir(workbench_path) do
  puts "  Working in #{Dir.pwd}"
  puts '  Pulling latest ...'
  puts "  #{`git pull`}"
  puts '  Creating symlinks ...'

   Dir.glob('*') do |item|
    next if ['README.md', 'fonts', 'tags', '.bundle', 'nginx'].include?(item)
    if ['bin', 'tmux'].include?(item)
      `rm -rf ~/#{item}`
      `ln -sfh #{workbench_path}/#{item} ~/`
    else
      `rm -rf ~/.#{item}`
      `ln -sfh #{workbench_path}/#{item} ~/.#{item}`
    end
  end
end

# setting crontab
puts '  Setting local crontab ...'
`crontab #{workbench_path}/crontab`

# upgrade vim-plug plugin, then all upgrade all plugin
puts '  Updating vim plugins ...'
# make sure vim backup dir exists
`mkdir -p ~/.vim/tmp`
`vi +PlugUpgrade +PlugUpdate +PlugClean +qall`

# set nginx config
puts '  Setting nginx config'
`mkdir -p /usr/local/var/log`
`mkdir -p /usr/local/var/log/nginx`
`mkdir -p /usr/local/etc/nginx`
`ln -sfh #{workbench_path}/nginx/nginx.conf /usr/local/etc/nginx/nginx.conf`
`ln -sfh #{workbench_path}/nginx/sites-available /usr/local/etc/nginx/sites-available`
`ln -sfh #{workbench_path}/nginx/sites-enabled /usr/local/etc/nginx/sites-enabled`

puts "\n  All done!"
