#!/usr/bin/env ruby

path = File.expand_path('./', File.dirname(__FILE__))
bin_path = File.symlink?(path) ? File.readlink(path) : path
workbench_path = File.expand_path('.././', bin_path)
host = `hostname`.split(".").first

puts "Installing the workbench (on #{host})"

Dir.chdir(workbench_path) do
  puts "  Working in #{Dir.pwd}"
  puts '  Pulling latest ...'
  puts "  #{`git pull`}"
  puts '  Creating symlinks ...'

   Dir.glob('*') do |item|
    next if ['README.md', 'apple_scripts', 'fonts', 'tags', '.bundle', 'nginx', 'launchd'].include?(item)
    if ['bin', 'tmux'].include?(item)
      `rm -rf ~/#{item}`
      `ln -sfh #{workbench_path}/#{item} ~/`
    else
      `rm -rf ~/.#{item}`
      `ln -sfh #{workbench_path}/#{item} ~/.#{item}`
    end
  end
end

# install/update launchd for this host (if we have any)
launchd_scripts = Dir.glob("launchd/#{host}/*")
if launchd_scripts.empty?
  puts "  No launchd scripts to apply for #{host} ..."
else
  puts "  Installing launchd scripts for #{host} ..."
  launchd_scripts.each do |launchd_script|
    script_name = launchd_script.split('/').last
    next if File.exists?("/Library/LaunchDaemons/#{script_name}")
    puts "    - #{script_name} applying ..."
    `sudo ln -sfh #{workbench_path}/#{launchd_script} /Library/LaunchDaemons`
    `launchctl load -w /Library/LaunchDaemons/#{script_name}`
  end
end

# upgrade vim-plug plugin, then all upgrade all plugins
puts '  Updating vim plugins ...'
`vim +PlugUpgrade +PlugUpdate +PlugClean! +qa!`
# make sure vim backup dir exists
`mkdir -p ~/.vim/tmp`

# setup local nginx config
puts '  Applying nginx config ...'
`mkdir -p /usr/local/var/log/nginx`
`mkdir -p /usr/local/etc/nginx`
`mkdir -p /usr/local/etc/nginx/client_body_temp`
`ln -sfh #{workbench_path}/nginx/nginx.conf /usr/local/etc/nginx/nginx.conf`
`ln -sfh #{workbench_path}/nginx/sites-available /usr/local/etc/nginx/sites-available`
`ln -sfh #{workbench_path}/nginx/sites-enabled /usr/local/etc/nginx/sites-enabled`

# ensure local ssl certs exist for dev domains
nginx_dir = "/usr/local/etc/nginx"
domains   = %w(pow.dev)
domains.each do |domain|
  next if File.exists?("#{nginx_dir}/ssl/#{domain}.crt")
  `nginx_ssl_cert_builder #{domain}`
end

puts "\n  All done!"
